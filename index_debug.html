<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Panel Image Uploader (Debug Mode)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .image-card {
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        .image-card:hover {
            transform: translateY(-5px);
        }
        .card-img-top {
            height: 200px;
            object-fit: cover;
        }
        .dropzone {
            border: 2px dashed #0087F7;
            border-radius: 5px;
            padding: 50px;
            text-align: center;
            margin-bottom: 20px;
            background-color: #f8f9ff;
            cursor: pointer;
        }
        .dropzone.highlight {
            border-color: #007bff;
            background-color: #e6f3ff;
        }
        #upload-progress {
            display: none;
        }
        .header-section {
            background-color: #343a40;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            border-radius: 0 0 10px 10px;
        }
        .btn-primary {
            background-color: #198754;
            border-color: #198754;
        }
        .btn-primary:hover {
            background-color: #146c43;
            border-color: #146c43;
        }
        .auth-status {
            font-size: 14px;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: #f8f9fa;
            display: inline-block;
        }
        .text-success {
            color: #198754 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        #debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
        }
        .debug-actions {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-section text-center">
            <h1>Solar Panel Image Uploader <span class="badge bg-warning">Debug Mode</span></h1>
            <p class="lead">Upload and manage thermal images for solar panel fault detection</p>
            <div id="auth-status" class="auth-status mt-2">Authenticating...</div>
        </div>

        <!-- Debug Panel -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h3>Debug Panel</h3>
            </div>
            <div class="card-body">
                <div class="debug-actions">
                    <button id="debug-sign-in" class="btn btn-sm btn-primary">Sign In Anonymously</button>
                    <button id="debug-sign-out" class="btn btn-sm btn-secondary">Sign Out</button>
                    <button id="debug-check-auth" class="btn btn-sm btn-info">Check Auth</button>
                    <button id="debug-clear" class="btn btn-sm btn-outline-danger">Clear Log</button>
                </div>
                <div id="debug-panel"></div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 offset-md-2">
                <!-- Upload Section -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3>Upload Images</h3>
                    </div>
                    <div class="card-body">
                        <div id="dropzone" class="dropzone">
                            <div class="dz-message">
                                <h4>Drop files here or click to upload</h4>
                                <p>Upload thermal images of solar panels for analysis</p>
                            </div>
                            <input type="file" id="fileInput" style="display: none;" accept="image/*">
                        </div>

                        <div id="upload-progress" class="progress mt-3">
                            <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>

                        <div class="text-center mt-3">
                            <button id="upload-button" class="btn btn-primary">Select Files</button>
                        </div>
                    </div>
                </div>

                <!-- Images Gallery -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <h3>Uploaded Images</h3>
                    </div>
                    <div class="card-body">
                        <div id="image-container" class="row">
                            <div class="col-12 text-center" id="loading-message">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p>Loading images...</p>
                            </div>
                            <!-- Images will be displayed here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBceHKO6VqiLj1dnU8jdRTjnI0QmC1ltuM",
            authDomain: "solarpanel-b1346.firebaseapp.com",
            projectId: "solarpanel-b1346",
            storageBucket: "solarpanel-b1346.firebasestorage.app",
            messagingSenderId: "730583933743",
            appId: "1:730583933743:web:9afed9e1d12b2d8dbef60b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        // Get a reference to the Firebase services
        const storage = firebase.storage();
        const auth = firebase.auth();
        const storageRef = storage.ref();
        const panelImagesRef = storageRef.child('panel images');

        // DOM elements
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('upload-button');
        const uploadProgress = document.getElementById('upload-progress');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const imageContainer = document.getElementById('image-container');
        const loadingMessage = document.getElementById('loading-message');
        const authStatusElement = document.getElementById('auth-status');
        const debugPanel = document.getElementById('debug-panel');
        const debugSignInBtn = document.getElementById('debug-sign-in');
        const debugSignOutBtn = document.getElementById('debug-sign-out');
        const debugCheckAuthBtn = document.getElementById('debug-check-auth');
        const debugClearBtn = document.getElementById('debug-clear');

        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugPanel.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        // Clear debug log
        function clearDebugLog() {
            debugPanel.innerHTML = '';
        }

        // Debug panel buttons
        debugSignInBtn.addEventListener('click', () => {
            debugLog('Manually triggering anonymous sign-in...');
            signInAnonymously();
        });

        debugSignOutBtn.addEventListener('click', () => {
            debugLog('Signing out...');
            auth.signOut().then(() => {
                debugLog('Signed out successfully');
            }).catch(error => {
                debugLog(`Sign out error: ${error.message}`);
            });
        });

        debugCheckAuthBtn.addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
                debugLog(`Current user: ${user.uid} (Anonymous: ${user.isAnonymous})`);
            } else {
                debugLog('No user is currently signed in');
            }
        });

        debugClearBtn.addEventListener('click', clearDebugLog);

        // Sign in anonymously
        function signInAnonymously() {
            debugLog('Attempting anonymous sign-in...');
            auth.signInAnonymously()
                .then(() => {
                    debugLog('Signed in anonymously successfully');
                    if (authStatusElement) {
                        authStatusElement.innerHTML = 'Authenticated anonymously';
                        authStatusElement.classList.add('text-success');
                    }
                    // Load images after authentication
                    loadImages();
                })
                .catch((error) => {
                    debugLog(`Error signing in anonymously: ${error.code} - ${error.message}`);
                    if (authStatusElement) {
                        authStatusElement.innerHTML = 'Authentication failed: ' + error.message;
                        authStatusElement.classList.add('text-danger');
                    }
                });
        }

        // Monitor auth state
        auth.onAuthStateChanged((user) => {
            if (user) {
                debugLog(`Auth state changed: User ${user.uid} is signed in (Anonymous: ${user.isAnonymous})`);
                if (authStatusElement) {
                    authStatusElement.innerHTML = 'Authenticated anonymously';
                    authStatusElement.classList.add('text-success');
                }
                // Load images when authenticated
                loadImages();
            } else {
                debugLog('Auth state changed: User is signed out');
                if (authStatusElement) {
                    authStatusElement.innerHTML = 'Not authenticated';
                    authStatusElement.classList.add('text-danger');
                }
                // Try to sign in if not authenticated
                signInAnonymously();
            }
        });

        // Event listeners for drag and drop
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('highlight');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('highlight');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('highlight');
            
            if (e.dataTransfer.files.length) {
                handleFiles(e.dataTransfer.files);
            }
        });

        // Click events
        dropzone.addEventListener('click', () => {
            fileInput.click();
        });

        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFiles(e.target.files);
            }
        });

        // Handle file uploads
        function handleFiles(files) {
            // Check if user is authenticated
            if (!auth.currentUser) {
                debugLog('User not authenticated for upload, attempting to sign in...');
                alert('Please wait while we authenticate you...');
                signInAnonymously();
                return;
            }
            
            debugLog(`Uploading ${files.length} file(s)...`);
            Array.from(files).forEach(file => {
                uploadFile(file);
            });
        }

        // Upload a file to Firebase Storage
        function uploadFile(file) {
            debugLog(`Starting upload for file: ${file.name}`);
            
            // Show progress bar
            uploadProgress.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            
            // Create a storage reference
            const fileName = file.name;
            const fileRef = panelImagesRef.child(fileName);
            
            // Upload file
            const uploadTask = fileRef.put(file);
            
            // Monitor upload progress
            uploadTask.on('state_changed',
                // Progress
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    uploadProgressBar.style.width = progress + '%';
                    uploadProgressBar.textContent = Math.round(progress) + '%';
                    
                    if (progress % 25 === 0) {
                        debugLog(`Upload progress: ${Math.round(progress)}%`);
                    }
                },
                // Error
                (error) => {
                    debugLog(`Upload failed: ${error.code} - ${error.message}`);
                    console.error('Upload failed:', error);
                    alert('Upload failed: ' + error.message);
                    uploadProgress.style.display = 'none';
                },
                // Complete
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        debugLog(`File uploaded successfully: ${fileName}`);
                        debugLog(`Download URL: ${downloadURL}`);
                        uploadProgress.style.display = 'none';
                        loadImages(); // Refresh the image gallery
                    });
                }
            );
        }

        // Load images from Firebase Storage
        function loadImages() {
            // Check if user is authenticated
            if (!auth.currentUser) {
                debugLog('User not authenticated for loading images, waiting for auth...');
                return;
            }
            
            debugLog('Loading images from Firebase Storage...');
            
            // Clear previous images
            const imageElements = document.querySelectorAll('.image-item');
            imageElements.forEach(el => el.remove());
            
            // Show loading message
            loadingMessage.style.display = 'block';
            
            // List all the items in the 'panel images' folder
            panelImagesRef.listAll()
                .then((res) => {
                    debugLog(`Found ${res.items.length} images in storage`);
                    
                    if (res.items.length === 0) {
                        imageContainer.innerHTML = '<div class="col-12 text-center"><p>No images uploaded yet</p></div>';
                        loadingMessage.style.display = 'none';
                        return;
                    }
                    
                    // Hide loading once we start getting results
                    loadingMessage.style.display = 'none';
                    
                    // Process each image
                    res.items.forEach((itemRef) => {
                        // Get the download URL
                        itemRef.getDownloadURL().then((url) => {
                            debugLog(`Got URL for image: ${itemRef.name}`);
                            // Create image card
                            const imageCard = createImageCard(itemRef.name, url);
                            imageContainer.appendChild(imageCard);
                        }).catch(error => {
                            debugLog(`Error getting URL for ${itemRef.name}: ${error.message}`);
                        });
                    });
                })
                .catch((error) => {
                    debugLog(`Error listing images: ${error.code} - ${error.message}`);
                    console.error('Error loading images:', error);
                    imageContainer.innerHTML = `<div class="col-12 text-center"><p>Error loading images: ${error.message}</p></div>`;
                    loadingMessage.style.display = 'none';
                });
        }

        // Create an image card element
        function createImageCard(name, url) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 image-item';
            
            col.innerHTML = `
                <div class="card image-card">
                    <img src="${url}" class="card-img-top" alt="${name}">
                    <div class="card-body">
                        <h5 class="card-title">${name}</h5>
                        <div class="d-flex justify-content-between">
                            <a href="${url}" class="btn btn-sm btn-primary" target="_blank">View Full Size</a>
                            <button class="btn btn-sm btn-danger delete-btn" data-name="${name}">Delete</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listener for delete button
            const deleteBtn = col.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', () => {
                if (confirm(`Are you sure you want to delete ${name}?`)) {
                    deleteImage(name);
                }
            });
            
            return col;
        }

        // Delete an image from Firebase Storage
        function deleteImage(name) {
            // Check if user is authenticated
            if (!auth.currentUser) {
                debugLog('User not authenticated for delete, attempting to sign in...');
                alert('Please wait while we authenticate you...');
                signInAnonymously();
                return;
            }
            
            debugLog(`Attempting to delete image: ${name}`);
            const imageRef = panelImagesRef.child(name);
            
            imageRef.delete().then(() => {
                debugLog(`Image deleted successfully: ${name}`);
                loadImages(); // Refresh the image list
            }).catch((error) => {
                debugLog(`Error deleting image: ${error.code} - ${error.message}`);
                console.error('Error deleting image:', error);
                alert('Error deleting image: ' + error.message);
            });
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            debugLog('Page loaded, initializing app...');
            
            // Check if already signed in
            if (auth.currentUser) {
                debugLog(`Already authenticated as: ${auth.currentUser.uid}`);
                loadImages();
            } else {
                debugLog('No current user, will attempt anonymous sign-in');
            }
        });
    </script>
</body>
</html> 